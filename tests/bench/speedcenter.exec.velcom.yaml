- attributes:
    description: stdlib
    tags: [slow]
    time: &time
      #runner: time
      # alternative config: use `perf stat` for extended properties
      runner: perf_stat
      perf_stat:
        properties:
          [
            "wall-clock",
            "task-clock",
            "instructions",
            "branches",
            "branch-misses",
          ]
      rusage_properties: ["maxrss"]
  run_config:
    <<: *time
    cmd: |
      bash -c 'set -eo pipefail; touch ../../src/Init/Prelude.lean; make LEAN_OPTS="-Dprofiler=true -Dprofiler.threshold=9999" -C ${BUILD:-../../build/release}/stage2 --output-sync -j$(nproc) 2>&1 | ./accumulate_profile.py'
    max_runs: 2
    parse_output: true
  # initialize stage2 cmake + warmup
  build_config:
    cmd: |
      bash -c 'make -C ${BUILD:-../../build/release} stage2 -j$(nproc)'
- attributes:
    description: stdlib size
    tags: [deterministic, fast]
  run_config:
    cwd: ../../
    cmd: |
      set -euxo pipefail
      echo -n 'lines: '
      find src -name '*.lean' -print0 | wc -l --files0-from=- | tail -1 | cut -d' ' -f 1
      echo -n 'bytes .olean: '
      find ${BUILD:-build/release}/stage2/lib/lean -name '*.olean' -print0 | wc -c --files0-from=- | tail -1 | cut -d' ' -f 1
      echo -n 'lines C: '
      find ${BUILD:-build/release}/stage2/lib/temp -name '*.c' -print0 | wc -l --files0-from=- | tail -1 | cut -d' ' -f 1
      echo -n 'lines C++: '
      find src \( -name '*.h' -o -name '*.cpp' \) -print0 | wc -l --files0-from=- | tail -1 | cut -d' ' -f 1
      echo -n 'max dynamic symbols: '
      find ${BUILD:-build/release}/stage2/lib/lean -name '*.a' -exec bash -c 'nm {} | grep " T " | wc -l' \; | sort --reverse --numeric-sort | head -n1
    max_runs: 1
    runner: output
- attributes:
    description: libleanshared.so
    tags: [deterministic, fast]
  run_config:
    cmd: |
      set -eu
      echo -n 'binary size: '
      wc -c ${BUILD:-../../build/release}/stage2/lib/lean/libleanshared.so | cut -d' ' -f 1
    max_runs: 1
    runner: output
- attributes:
    description: import Lean
    tags: [fast]
  run_config:
    <<: *time
    cmd: lean ../../src/Lean.lean
